"use strict";$(function(){var e=firebase.database();if($("plot-content").length){var t=$(".select-fypp"),o=t.select2(),n="",a=JSON.parse(localStorage.getItem("plotContent")),r=function(){a=JSON.parse(localStorage.getItem("plotContent")),a?($("plot-search").hide(),$("plot-content").show(),a.promo?($('[promo="true"]').show(),$('[promo="false"]').hide()):($('[promo="true"]').hide(),$('[promo="false"]').show()),$(".page__content").html(a.infoHtml),$(".page__backdrop").css("opacity",.2)):($("plot-search").show(),$("plot-content").hide(),$(".page__backdrop").css("opacity",1))};r(),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?no_parent=true",success:function(e){var o=[{id:0,cityId:null,text:"Выберите",selected:!0}];e.filter(function(e,t){e.name=e.name.replace(/город /,""),o.push({id:t+1,cityId:e.id,text:e.name})}),t.select2("destroy").empty().select2({data:o})}}),o.on("select2:select",function(o){var a=o.params.data;n+=""===n?o.params.data.text:", "+o.params.data.text,$(".page__plot span").html(n),a.cityId&&$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?parent="+a.cityId,success:function(o){if(console.log(o),o.length){var n=[{id:0,cityId:null,text:"Выберите",selected:!0}];o.filter(function(e,t){n.push({id:t+1,cityId:e.id,text:e.name.replace(/&quot;/g,'"')})}),t.select2("destroy").empty().select2({data:n})}else t.prop("disabled",!0),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/"+a.cityId+"/precinct/",success:function(o){t.prop("disabled",!1),localStorage.setItem("plotContent",JSON.stringify(o)),r();var n=o.promo?"promo":"not_promo",a=e.ref("regions/"+n+"/"+o.id);a.update({id:o.id,number:o.data.number,address:o.data.address,votingAddress:o.data.votingAddress}).then(function(){a.once("value").then(function(e){e.val().foundOnce?a.update({foundOnce:e.val().foundOnce+1}):a.update({foundOnce:1})})})}})}})}),$("[search-again]").on("click",function(){n="",$(".page__plot span").html("&mdash;"),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?no_parent=true",success:function(e){var o=[{id:0,cityId:null,text:"Выберите",selected:!0}];e.filter(function(e,t){e.name=e.name.replace(/город /,""),o.push({id:t+1,cityId:e.id,text:e.name.replace(/&quot;/g,'"')})}),t.select2("destroy").empty().select2({data:o}),localStorage.removeItem("plotContent"),r()}})})}}),$(function(){var e=$("#map");if(e.length){var t=void 0;t=$(".map_perm").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=121146":$(".map_kaliningrad").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=804276":$(".map_sovetsk").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=1839428":"https://electionself.fenwik.ru/api/precincts/?promo=true",$.ajax({method:"GET",url:t,success:function(e){var t=e;$(".map_sovetsk").length&&(t=t.filter(function(e){if("690"!==e.data.number&&"691"!==e.data.number)return e})),ymaps.ready(function(){var e=new ymaps.Map("map",{center:[0,0],zoom:9},{searchControlProvider:"yandex#search"}),o=new ymaps.Clusterer({preset:"islands#invertedVioletClusterIcons",clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1});o.events.add(["mouseenter","mouseleave"],function(e){var t=e.get("target"),o=e.get("type");"undefined"!=typeof t.getGeoObjects?"mouseenter"==o?t.options.set("preset","islands#invertedPinkClusterIcons"):t.options.set("preset","islands#invertedVioletClusterIcons"):"mouseenter"==o?t.options.set("preset","islands#pinkIcon"):t.options.set("preset","islands#violetIcon")});for(var n=function(e,t){return{balloonContentHeader:"<h4>Участок №"+e.data.number+"</h4>",balloonContentBody:"<b>Адрес:</b> "+e.data.address,clusterCaption:"Участок <strong>№"+e.data.number+"</strong>"}},a=function(){return{preset:"islands#violetIcon"}},r=t,s=[],i=0,c=r.length;i<c;i++)null!==r[i].geoPosition&&(s[i]=new ymaps.Placemark([r[i].geoPosition.latitude,r[i].geoPosition.longitude],n(r[i],i),a()),o.add(s[i]));e.geoObjects.add(o),e.setBounds(o.getBounds(),{checkZoomRange:!0})})}}),$("[search-again]").on("click",function(e){e.preventDefault(),localStorage.removeItem("plotContent"),location.href=$(this).attr("href")})}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$document=$(document),$window=$(window),$body=$(document.body),searchParams=function(e){var t={};return e.replace(/\?/,"").split("&").forEach(function(e){t[e.split("=")[0]]=e.split("=")[1]}),t},getString=function(e){function t(e,n){return Array.isArray(e)?void e.forEach(function(e){t(e,n+"[]")}):null!==e&&"object"===("undefined"==typeof e?"undefined":_typeof(e))?void Object.keys(e).forEach(function(o){t(e[o],n+"["+o+"]")}):void o.push(n+"="+e)}var o=[];return Object.keys(e).forEach(function(o){t(e[o],o)}),o.join("&")};$(function(){var e=firebase.database(),t=searchParams(location.search);$(document).on("ready",function(){"vk"===t.app?VK.init(function(){console.log(t);var o=e.ref("users/vk/"+t.viewer_id);o.update({}).then(function(){console.log(1)})},function(){window.reload()},"5.68"):"ok"===t.app})});