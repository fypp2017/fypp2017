"use strict";$(function(){var e=firebase.database();if($("plot-content").length){var t=$(".select-fypp"),n=t.select2(),o="",a=JSON.parse(localStorage.getItem("plotContent")),r=function(){a=JSON.parse(localStorage.getItem("plotContent")),a?($("plot-search").hide(),$("plot-content").show(),a.promo?($('[promo="true"]').show(),$('[promo="false"]').hide()):($('[promo="true"]').hide(),$('[promo="false"]').show()),$(".page__content").html(a.infoHtml),$(".page__backdrop").css("opacity",.2)):($("plot-search").show(),$("plot-content").hide(),$(".page__backdrop").css("opacity",1))};r(),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?no_parent=true",success:function(e){var n=[{id:0,cityId:null,text:"Выберите",selected:!0}];e.filter(function(e,t){e.name=e.name.replace(/город /,""),n.push({id:t+1,cityId:e.id,text:e.name})}),t.select2("destroy").empty().select2({data:n})}}),n.on("select2:select",function(n){var a=n.params.data;o+=""===o?n.params.data.text:", "+n.params.data.text,$(".page__plot span").html(o),a.cityId&&$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?parent="+a.cityId,success:function(n){if(console.log(n),n.length){var o=[{id:0,cityId:null,text:"Выберите",selected:!0}];n.filter(function(e,t){o.push({id:t+1,cityId:e.id,text:e.name.replace(/&quot;/g,'"')})}),t.select2("destroy").empty().select2({data:o})}else t.prop("disabled",!0),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/"+a.cityId+"/precinct/",success:function(n){t.prop("disabled",!1),localStorage.setItem("plotContent",JSON.stringify(n)),r();var o=n.promo?"promo":"not_promo",a=e.ref("regions/"+o+"/"+n.id);a.update({id:n.id,number:n.data.number,address:n.data.address,votingAddress:n.data.votingAddress}).then(function(){a.once("value").then(function(e){e.val().foundOnce?a.update({foundOnce:e.val().foundOnce+1}):a.update({foundOnce:1})})})}})}})}),$("[search-again]").on("click",function(){o="",$(".page__plot span").html("&mdash;"),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?no_parent=true",success:function(e){var n=[{id:0,cityId:null,text:"Выберите",selected:!0}];e.filter(function(e,t){e.name=e.name.replace(/город /,""),n.push({id:t+1,cityId:e.id,text:e.name.replace(/&quot;/g,'"')})}),t.select2("destroy").empty().select2({data:n}),localStorage.removeItem("plotContent"),r()}})})}}),$(function(){var e=$("#map");if(e.length){var t=void 0;t=$(".map_perm").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=121146":$(".map_kaliningrad").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=804276":$(".map_sovetsk").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=1839428":"https://electionself.fenwik.ru/api/precincts/?promo=true",$.ajax({method:"GET",url:t,success:function(e){var t=e;$(".map_sovetsk").length&&(t=t.filter(function(e){if("690"!==e.data.number&&"691"!==e.data.number)return e})),ymaps.ready(function(){var e=new ymaps.Map("map",{center:[0,0],zoom:9},{searchControlProvider:"yandex#search"}),n=new ymaps.Clusterer({preset:"islands#invertedVioletClusterIcons",clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1});n.events.add(["mouseenter","mouseleave"],function(e){var t=e.get("target"),n=e.get("type");"undefined"!=typeof t.getGeoObjects?"mouseenter"==n?t.options.set("preset","islands#invertedPinkClusterIcons"):t.options.set("preset","islands#invertedVioletClusterIcons"):"mouseenter"==n?t.options.set("preset","islands#pinkIcon"):t.options.set("preset","islands#violetIcon")});for(var o=function(e,t){return{balloonContentHeader:"<h4>Участок №"+e.data.number+"</h4>",balloonContentBody:"<b>Адрес:</b> "+e.data.address,clusterCaption:"Участок <strong>№"+e.data.number+"</strong>"}},a=function(){return{preset:"islands#violetIcon"}},r=t,s=[],i=0,c=r.length;i<c;i++)null!==r[i].geoPosition&&(s[i]=new ymaps.Placemark([r[i].geoPosition.latitude,r[i].geoPosition.longitude],o(r[i],i),a()),n.add(s[i]));e.geoObjects.add(n),e.setBounds(n.getBounds(),{checkZoomRange:!0})})}}),$("[search-again]").on("click",function(e){e.preventDefault(),localStorage.removeItem("plotContent"),location.href=$(this).attr("href")})}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$document=$(document),$window=$(window),$body=$(document.body),searchParams=function(e){var t={};return e.replace(/\?/,"").split("&").forEach(function(e){t[e.split("=")[0]]=e.split("=")[1]}),t},getString=function(e){function t(e,o){return Array.isArray(e)?void e.forEach(function(e){t(e,o+"[]")}):null!==e&&"object"===("undefined"==typeof e?"undefined":_typeof(e))?void Object.keys(e).forEach(function(n){t(e[n],o+"["+n+"]")}):void n.push(o+"="+e)}var n=[];return Object.keys(e).forEach(function(n){t(e[n],n)}),n.join("&")};$(function(){var e=firebase.database(),t=searchParams(location.search);$(document).on("ready",function(){if("vk"===t.app)VK.init(function(){var n=e.ref("users"),o=e.ref("users/users/"+t.viewer_id);o.update({app:"vk"}).then(function(){n.once("value").then(function(e){var t=0;for(var o in e.val().users)"vk"===e.val().users[o].app&&(t+=1);n.update({vkCount:t})})})},function(){window.reload()},"5.68");else if("ok"===t.app){var n=FAPI.Util.getRequestParameters();FAPI.init(n.api_server,n.apiconnection,function(){FAPI.Client.call({fields:"uid",method:"users.getCurrentUser"},function(t,n,o){var a=e.ref("users"),r=e.ref("users/users/"+n.uid);r.update({app:"ok"}).then(function(){a.once("value").then(function(e){var t=0;for(var n in e.val().users)"ok"===e.val().users[n].app&&(t+=1);a.update({okCount:t})})})})},function(e){window.reload()})}})});