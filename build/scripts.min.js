"use strict";$(function(){var e=$("#map");if(e.length){var t=void 0;t=$(".map_perm").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=121146":$(".map_kaliningrad").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=804276":$(".map_sovetsk").length?"https://electionself.fenwik.ru/api/precincts/?promo=true&root_geo_node=1839428":"https://electionself.fenwik.ru/api/precincts/?promo=true",$.ajax({method:"GET",url:t,success:function(e){var t=e;$(".map_sovetsk").length&&(t=t.filter(function(e){if("690"!==e.data.number&&"691"!==e.data.number)return e})),ymaps.ready(function(){var e=new ymaps.Map("map",{center:[0,0],zoom:9},{searchControlProvider:"yandex#search"}),n=new ymaps.Clusterer({preset:"islands#invertedVioletClusterIcons",clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1});n.events.add(["mouseenter","mouseleave"],function(e){var t=e.get("target"),n=e.get("type");"undefined"!=typeof t.getGeoObjects?"mouseenter"==n?t.options.set("preset","islands#invertedPinkClusterIcons"):t.options.set("preset","islands#invertedVioletClusterIcons"):"mouseenter"==n?t.options.set("preset","islands#pinkIcon"):t.options.set("preset","islands#violetIcon")});for(var i=function(e,t){return{balloonContentHeader:"<h4>Участок №"+e.data.number+"</h4>",balloonContentBody:"<b>Адрес:</b> "+e.data.address,clusterCaption:"Участок <strong>№"+e.data.number+"</strong>"}},o=function(){return{preset:"islands#violetIcon"}},r=t,a=[],s=0,c=r.length;s<c;s++)null!==r[s].geoPosition&&(a[s]=new ymaps.Placemark([r[s].geoPosition.latitude,r[s].geoPosition.longitude],i(r[s],s),o()),n.add(a[s]));e.geoObjects.add(n),e.setBounds(n.getBounds(),{checkZoomRange:!0})})}}),$("[search-again]").on("click",function(e){e.preventDefault(),localStorage.removeItem("plotContent"),location.href=$(this).attr("href")})}}),$(function(){var e=firebase.database();if($("plot-content").length){var t=$(".select-fypp"),n=t.select2(),i="",o=JSON.parse(localStorage.getItem("plotContent")),r=function(){o=JSON.parse(localStorage.getItem("plotContent")),o?($("plot-search").hide(),$("plot-content").show(),o.promo?($('[promo="true"]').show(),$('[promo="false"]').hide()):($('[promo="true"]').hide(),$('[promo="false"]').show()),$(".page__content").html(o.infoHtml),$(".page__backdrop").css("opacity",.2)):($("plot-search").show(),$("plot-content").hide(),$(".page__backdrop").css("opacity",1))};r(),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?no_parent=true",success:function(e){var n=[{id:0,cityId:null,text:"Выберите",selected:!0}];e.filter(function(e,t){e.name=e.name.replace(/город /,""),n.push({id:t+1,cityId:e.id,text:e.name})}),t.select2("destroy").empty().select2({data:n})}}),n.on("select2:select",function(n){var o=n.params.data;i+=""===i?n.params.data.text:", "+n.params.data.text,$(".page__plot span").html(i),o.cityId&&$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?parent="+o.cityId,success:function(n){if(console.log(n),n.length){var i=[{id:0,cityId:null,text:"Выберите",selected:!0}];n.filter(function(e,t){i.push({id:t+1,cityId:e.id,text:e.name.replace(/&quot;/g,'"')})}),t.select2("destroy").empty().select2({data:i})}else t.prop("disabled",!0),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/"+o.cityId+"/precinct/",success:function(n){t.prop("disabled",!1),localStorage.setItem("plotContent",JSON.stringify(n)),r();var i=n.promo?"promo":"not_promo",o=e.ref("regions/"+i+"/"+n.id);o.update({id:n.id,number:n.data.number,address:n.data.address,votingAddress:n.data.votingAddress}).then(function(){o.once("value").then(function(e){e.val().foundOnce?o.update({foundOnce:e.val().foundOnce+1}):o.update({foundOnce:1})})})}})}})}),$("[search-again]").on("click",function(){i="",$(".page__plot span").html("&mdash;"),$.ajax({method:"GET",url:"https://electionself.fenwik.ru/api/geo_nodes/?no_parent=true",success:function(e){var n=[{id:0,cityId:null,text:"Выберите",selected:!0}];e.filter(function(e,t){e.name=e.name.replace(/город /,""),n.push({id:t+1,cityId:e.id,text:e.name.replace(/&quot;/g,'"')})}),t.select2("destroy").empty().select2({data:n}),localStorage.removeItem("plotContent"),r()}})})}});var $document=$(document),$window=$(window),$body=$(document.body),BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS",this.platform=this.searchPlatform(navigator.userAgent)},searchString:function(e){for(var t=0;t<e.length;t++){var n=e[t].string,i=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,n){if(n.indexOf(e[t].subString)!=-1)return e[t].identity}else if(i)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(t!=-1)return parseFloat(e.substring(t+this.versionSearchString.length+1))},searchPlatform:function(e){var t,n=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i,i=/Win|Mac|Linux/i;return t=1==n.test(e)?"mobile":1==i.test(e)?"desktop":"unknown platform"},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();